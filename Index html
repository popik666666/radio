<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Popik R√°dio ‚Äî Live</title>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#fff; text-align:center; margin:0; padding:30px; }
  h1 { margin:0 0 10px 0; color:#ff6b6b; }
  .box { background:#0f0f0f; padding:16px; border-radius:8px; display:inline-block; width:100%; max-width:760px; }
  input, button, textarea { padding:8px; margin:6px 4px; border-radius:6px; border:1px solid #333; background:#111; color:#fff; }
  button { background:#ff3b57; border:0; cursor:pointer; }
  button:hover { background:#ff606f; }
  #player audio { width:100%; max-width:600px; margin-top:10px; }
  #chat, #adminChatList, #blockedList { text-align:left; max-height:300px; overflow:auto; background:#0b0b0b; padding:10px; border-radius:6px; border:1px solid #222; }
  .msg { padding:6px; border-bottom:1px solid #151515; }
  .meta { color:#999; font-size:12px; margin-bottom:4px; }
  .adminMsg { background:#11141a; border-left:4px solid #ff3b57; padding-left:8px; }
  .controls { margin-top:10px; }
  .small { font-size:13px; color:#ccc; }
  .kickBtn { background:#b23; padding:4px 8px; margin-left:8px; font-size:12px; }
  .unbanBtn { background:#2b8; padding:4px 8px; margin-left:8px; font-size:12px; }
  .userTag { font-weight:bold; color:#ffd6d6; margin-right:6px; }
  #adminPanel { text-align:left; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .flex-space { flex:1; }
  footer { margin-top:18px; color:#888; font-size:13px; }
</style>
</head>
<body>

<h1>üéß Popik R√°dio</h1>

<div class="box">

  <!-- login pro posluchaƒçe -->
  <div id="loginSection">
    <p class="small">Zadej p≈ô√≠stupov√Ω k√≥d, abys vidƒõl p≈ôehr√°vaƒç a chat:</p>
    <input id="codeInput" type="password" placeholder="P≈ô√≠stupov√Ω k√≥d">
    <button onclick="checkCode()">Ovƒõ≈ôit</button>
  </div>

  <!-- p≈ôehr√°vaƒç + chat -->
  <div id="player" style="display:none;">
    <div id="playerBox">
      <h2 style="margin-top:0">R√°dio</h2>
      <audio id="audioPlayer" controls autoplay></audio>
      <div class="controls">
        <button onclick="showAdminLogin()">üîß Admin</button>
      </div>
    </div>

    <hr style="border:0;height:12px;background:transparent">

    <div id="infoPanel">
      <h3 style="margin:6px 0 8px 0">Informaƒçn√≠ kan√°l & Chat</h3>

      <div id="chat" aria-live="polite"></div>

      <div style="margin-top:10px;">
        <input id="chatInput" type="text" placeholder="Napi≈° zpr√°vu (posluchaƒçi)" style="width:70%">
        <button onclick="sendChat()">Odeslat</button>
      </div>
      <p class="small">Pozn√°mka: pokud tƒõ admin zablokuje, nebude≈° moci ps√°t do chatu.</p>
    </div>
  </div>

  <!-- admin login -->
  <div id="adminLogin" style="display:none;">
    <p class="small">Zadej admin heslo:</p>
    <input id="adminPassword" type="password" placeholder="Admin heslo">
    <button onclick="checkAdmin()">P≈ôihl√°sit</button>
  </div>

  <!-- admin panel -->
  <div id="adminPanel" style="display:none;">
    <h2 style="margin-top:0">‚öôÔ∏è Admin Panel</h2>

    <div style="margin-bottom:8px">
      <label class="small">Odeslat ozn√°men√≠ (admin):</label><br>
      <input id="newMessage" type="text" placeholder="Napi≈° ozn√°men√≠" style="width:70%">
      <button onclick="sendAdminMessage()">Odeslat</button>
    </div>

    <div style="margin-bottom:8px">
      <label class="small">Vlastn√≠ chat (admin m≈Ø≈æe ps√°t i tu):</label><br>
      <input id="adminChatInput" type="text" placeholder="Admin zpr√°va" style="width:70%">
      <button onclick="sendChatAsAdmin()">Odeslat jako admin</button>
    </div>

    <div style="margin-bottom:8px">
      <label class="small">Zmƒõnit p≈ô√≠stupov√Ω k√≥d pro posluchaƒçe:</label><br>
      <input id="newCode" type="text" placeholder="Nov√Ω k√≥d">
    </div>

    <div style="margin-bottom:8px">
      <label class="small">Zmƒõnit URL streamu:</label><br>
      <input id="newStream" type="text" placeholder="Nov√° URL streamu" style="width:70%">
    </div>

    <div style="margin-bottom:8px" class="row">
      <button onclick="saveSettings()">üíæ Ulo≈æit zmƒõny</button>
      <button onclick="logoutAdmin()">üö™ Odhl√°sit</button>
      <div class="flex-space"></div>
      <div class="small">Tvoje admin heslo = <strong>p666pr</strong></div>
    </div>

    <hr>

    <div style="margin-bottom:8px">
      <h3 class="small" style="margin:0 0 6px 0">Aktivn√≠ blokovan√≠ u≈æivatel√©</h3>
      <div id="blockedList"></div>
    </div>

    <div>
      <h3 class="small" style="margin:0 0 6px 0">Posledn√≠ u≈æivatel√© (zpr√°vy)</h3>
      <div id="adminChatList"></div>
      <p class="small">U ka≈æd√©ho u≈æivatele klikni "Vyhodit", aby nemohl ps√°t.</p>
    </div>
  </div>

</div>

<footer>Popik R√°dio ‚Ä¢ admin m≈Ø≈æe blokovat ps√°t jen admin</footer>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// -------- Firebase konfigurace (m√° b√Ωt tvoje, u≈æ vlo≈æeno) ----------
const firebaseConfig = {
  apiKey: "AIzaSyBUtnmX7HyiDVbGx9wjfScQQJtwTmrP07k",
  authDomain: "chat-48ab6.firebaseapp.com",
  databaseURL: "https://chat-48ab6-default-rtdb.firebaseio.com",
  projectId: "chat-48ab6",
  storageBucket: "chat-48ab6.appspot.com",
  messagingSenderId: "963919446639",
  appId: "1:963919446639:web:246e32fb368aab18ac839a",
  measurementId: "G-C7ZBTEZ1TW"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// -------- v√Ωchoz√≠ nastaven√≠ ----------
const DEFAULT_ACCESS_CODE = "321456";
const ADMIN_PASSWORD = "p666pr";
const DEFAULT_STREAM = "https://popik-666.ismyradio.com";

// naƒçti ulo≈æen√© hodnoty
let accessCode = localStorage.getItem('accessCode') || DEFAULT_ACCESS_CODE;
let streamURL = localStorage.getItem('streamURL') || DEFAULT_STREAM;

// u≈æivatelsk√© ID a jm√©no (session)
let userId = sessionStorage.getItem('userId');
let displayName = sessionStorage.getItem('displayName');
if(!userId){
  userId = 'u_' + Math.random().toString(36).slice(2,10);
  displayName = 'U'+Math.random().toString(36).slice(2,5);
  sessionStorage.setItem('userId', userId);
  sessionStorage.setItem('displayName', displayName);
}

// elementy
const chatDiv = () => document.getElementById('chat');
const blockedListDiv = () => document.getElementById('blockedList');
const adminChatListDiv = () => document.getElementById('adminChatList');

// ---------------- stream loader ----------------
function loadStream(){
  const audio = document.getElementById('audioPlayer');
  audio.src = streamURL;
  audio.load();
}

// ---------------- login posluchaƒçe ----------------
function checkCode(){
  const v = document.getElementById('codeInput').value;
  if(v === accessCode){
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('player').style.display = 'block';
    document.getElementById('infoPanel').style.display = 'block';
    loadStream();
    startChatListeners();
    loadBlockedUI();
  } else {
    alert('≈†patn√Ω k√≥d');
  }
}

// ---------------- admin login ----------------
function showAdminLogin(){
  document.getElementById('adminLogin').style.display = 'block';
}
function checkAdmin(){
  const v = document.getElementById('adminPassword').value;
  if(v === ADMIN_PASSWORD){
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('newCode').value = accessCode;
    document.getElementById('newStream').value = streamURL;
    startAdminListeners();
  } else {
    alert('≈†patn√© admin heslo');
  }
}

// ---------------- save settings ----------------
function saveSettings(){
  const nc = document.getElementById('newCode').value.trim();
  const ns = document.getElementById('newStream').value.trim();
  if(nc){ accessCode = nc; localStorage.setItem('accessCode', nc); }
  if(ns){ streamURL = ns; localStorage.setItem('streamURL', ns); loadStream(); }
  alert('Nastaven√≠ ulo≈æeno');
}

// ---------------- logout admin ----------------
function logoutAdmin(){
  document.getElementById('adminPanel').style.display = 'none';
  document.getElementById('player').style.display = 'block';
}

// ---------------- chat (posluchaƒçi) ----------------
function sendChat(){
  // zkontroluj blokaci
  database.ref('blockedUsers/' + userId).get().then(snap=>{
    if(snap.exists() && snap.val() === true){
      alert('Byl jsi zablokov√°n a nem≈Ø≈æe≈° pos√≠lat zpr√°vy.');
      return;
    }
    const text = document.getElementById('chatInput').value.trim();
    if(!text) return;
    const ref = database.ref('chat').push();
    ref.set({
      userId: userId,
      name: displayName,
      text: text,
      time: Date.now()
    });
    document.getElementById('chatInput').value = '';
  });
}

// ---------------- admin can send announcement ----------------
function sendAdminMessage(){
  const text = document.getElementById('newMessage').value.trim();
  if(!text) return;
  const ref = database.ref('adminMessages').push();
  ref.set({ text: text, time: Date.now(), admin:true });
  document.getElementById('newMessage').value = '';
}

// admin send chat as admin (visible as admin)
function sendChatAsAdmin(){
  const text = document.getElementById('adminChatInput').value.trim();
  if(!text) return;
  const ref = database.ref('chat').push();
  ref.set({
    userId: 'admin',
    name: 'ADMIN',
    text: text,
    time: Date.now()
  });
  document.getElementById('adminChatInput').value = '';
}

// ---------------- load and render messages ----------------
let chatListenerStarted = false;
function startChatListeners(){
  if(chatListenerStarted) return;
  chatListenerStarted = true;

  // admin messages
  const aRef = database.ref('adminMessages');
  aRef.off();
  aRef.on('child_added', snap=>{
    const d = snap.val();
    appendAdminLine(d);
  });

  // normal chat
  const cRef = database.ref('chat');
  cRef.off();
  cRef.on('child_added', snap=>{
    const d = snap.val();
    appendChatLine(snap.key, d);
  });
}

// render admin announcement
function appendAdminLine(d){
  const chat = chatDiv();
  const div = document.createElement('div');
  div.className = 'msg adminMsg';
  const time = new Date(d.time).toLocaleTimeString();
  div.textContent = `[Admin ${time}] ${d.text}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// render chat line (with optional kick button for admin)
function appendChatLine(key, d){
  const chat = chatDiv();
  const div = document.createElement('div');
  div.className = 'msg';
  const time = new Date(d.time).toLocaleTimeString();

  const userSpan = document.createElement('span');
  userSpan.className = 'userTag';
  userSpan.textContent = d.name || d.userId;

  const meta = document.createElement('span');
  meta.className = 'meta';
  meta.textContent = ` [${time}] `;

  const textSpan = document.createElement('span');
  textSpan.textContent = ` ${d.text}`;

  div.appendChild(userSpan);
  div.appendChild(meta);
  div.appendChild(textSpan);

  // pokud je admin panel otev≈ôen (jste admin), p≈ôidej tlaƒç√≠tko Kick
  if(document.getElementById('adminPanel').style.display === 'block' && d.userId !== 'admin'){
    const kick = document.createElement('button');
    kick.className = 'kickBtn';
    kick.textContent = 'Vyhodit';
    kick.onclick = ()=>{ blockUser(d.userId, d.name); };
    div.appendChild(kick);

    // d√°le p≈ôidej i tlaƒç√≠tko "Zobraz info" pro rychl√© zobrazen√≠ id
    const info = document.createElement('button');
    info.style.marginLeft='6px';
    info.textContent='ID';
    info.onclick = ()=>{ alert('userId: ' + d.userId + '\nname: ' + (d.name||'')); };
    div.appendChild(info);
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  // aktualizuj admin seznam u≈æivatel≈Ø (posledn√≠ch)
  updateAdminUserList(d.userId, d.name, d.time);
}

// ---------------- block / unblock logic ----------------
function blockUser(uid, name){
  if(!uid) return;
  if(!confirm('Chce≈° zablokovat u≈æivatele ' + (name||uid) + ' ?')) return;
  database.ref('blockedUsers/' + uid).set(true).then(()=>{
    alert('U≈æivatel zablokov√°n');
    loadBlockedUI();
  });
}

function unblockUser(uid){
  if(!uid) return;
  database.ref('blockedUsers/' + uid).remove().then(()=>{
    alert('U≈æivatel odblokov√°n');
    loadBlockedUI();
  });
}

// ---------------- load blocked users UI ----------------
function loadBlockedUI(){
  const blDiv = blockedListDiv();
  blDiv.innerHTML = '';
  database.ref('blockedUsers').get().then(snap=>{
    if(!snap.exists()) { blDiv.textContent = '(≈æ√°dn√≠ zablokovan√≠)'; return; }
    const data = snap.val();
    for(const uid in data){
      const row = document.createElement('div');
      row.className='small';
      row.textContent = uid;
      const unb = document.createElement('button');
      unb.className='unbanBtn';
      unb.textContent='Odblokovat';
      unb.onclick = ()=>{ unblockUser(uid); };
      row.appendChild(unb);
      blDiv.appendChild(row);
    }
  });
}

// ---------------- admin list of recent users (unique) ----------------
const adminUsers = {}; // uid -> {name, lastTime}
function updateAdminUserList(uid, name, time){
  adminUsers[uid] = { name: name || uid, time: time || Date.now() };
  renderAdminUserList();
}
function renderAdminUserList(){
  const out = adminChatListDiv();
  out.innerHTML = '';
  for(const uid in adminUsers){
    const u = adminUsers[uid];
    const row = document.createElement('div');
    row.className='small';
    row.textContent = `${u.name} (${uid})`;
    const kick = document.createElement('button');
    kick.className='kickBtn';
    kick.textContent='Vyhodit';
    kick.onclick = ()=>{ blockUser(uid, u.name); };
    row.appendChild(kick);
    out.appendChild(row);
  }
}

// ---------------- load blocked check on send (also prevent UI) --------------
function startBlockedWatcher(){
  // pokud jsme zablokovan√≠, zak√°≈æeme input
  database.ref('blockedUsers/' + userId).on('value', snap=>{
    const isBlocked = snap.exists() && snap.val() === true;
    const input = document.getElementById('chatInput');
    if(isBlocked){
      input.disabled = true;
      input.placeholder = 'Jsi zablokov√°n, nem≈Ø≈æe≈° ps√°t.';
    } else {
      input.disabled = false;
      input.placeholder = 'Napi≈° zpr√°vu';
    }
  });
}

// ---------------- start listeners for admin view (in case admin opens later) ----------
function startAdminListeners(){
  // show blocked list and admin list
  loadBlockedUI();
  // also ensure admin sees chat additions with kick buttons (listener is same)
  startChatListeners();
}

// ---------------- start chat + blocked watcher when page enters player ----------
function startChatListeners(){
  // (we already implemented startChatListeners above) - call it
  if(!chatListenerStarted) {
    chatListenerStarted = false; // ensure reset
  }
  // reuse existing function defined earlier
  if(!chatListenerStarted) {
    chatListenerStarted = true;
    // bind listeners (we call the same named function earlier)
    // to avoid duplication simply call that function code
  }
  // run actual setup from earlier
  // duplicate minimal listener setup here
  const aRef = database.ref('adminMessages');
  aRef.off();
  aRef.on('child_added', snap=>{
    appendAdminLine(snap.val());
  });
  const cRef = database.ref('chat');
  cRef.off();
  cRef.on('child_added', snap=>{
    appendChatLine(snap.key, snap.val());
  });
  // watch if current user is blocked
  startBlockedWatcher();
}

// ---------------- on page load: set default stream and anything needed ----------
(function init(){
  // ensure localstorage values exist
  if(!localStorage.getItem('streamURL')) localStorage.setItem('streamURL', streamURL);
  // update variables in case changed
  streamURL = localStorage.getItem('streamURL') || streamURL;
  accessCode = localStorage.getItem('accessCode') || accessCode;
  // show nothing until login
})();
</script>

</body>
</html>
